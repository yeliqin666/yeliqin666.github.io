class ue extends Error{code="UNKNOWN";toJSON(){var{name:e,message:r,stack:t,code:a}=this;return{name:e,message:r,stack:t,code:a}}}class y extends ue{code="UNSUPPORTED_FILE"}class Ne{handlers=new Map;addEventHandler(e,r){this.handlers.set(e,r)}onmessage=async e=>{var{id:e,action:r,payload:t}=e.data,a=this.handlers.get(r);let _=null,i=null;if(a)try{_=await a(t)}catch(e){i=e instanceof ue?e.toJSON():e}else i=new Error("Handler missing for action "+r);postMessage({id:e,result:_,error:i})}}var b=(e=>(e.DECRYPT="DECRYPT",e.FIND_QMC_MUSICEX_NAME="FIND_QMC_MUSICEX_NAME",e.KUWO_PARSE_HEADER="KUWO_PARSE_HEADER",e.KUGOU_PARSE_HEADER="KUGOU_PARSE_HEADER",e.QINGTING_FM_GET_DEVICE_KEY="QINGTING_FM_GET_DEVICE_KEY",e.VERSION="VERSION",e))(b||{});let s,we=typeof TextDecoder<"u"?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:()=>{throw Error("TextDecoder not available")}},v=(typeof TextDecoder<"u"&&we.decode(),null);function E(){return v=null!==v&&0!==v.byteLength?v:new Uint8Array(s.memory.buffer)}function h(e,r){return e>>>=0,we.decode(E().subarray(e,e+r))}let _=0,K=typeof TextEncoder<"u"?new TextEncoder("utf-8"):{encode:()=>{throw Error("TextEncoder not available")}},ze="function"==typeof K.encodeInto?function(e,r){return K.encodeInto(e,r)}:function(e,r){var t=K.encode(e);return r.set(t),{read:e.length,written:t.length}};function g(e,r,t){if(void 0===t)return s=r((n=K.encode(e)).length,1)>>>0,E().subarray(s,s+n.length).set(n),_=n.length,s;let a=e.length,i=r(a,1)>>>0;var n,s,o=E();let c=0;for(;c<a;c++){var l=e.charCodeAt(c);if(127<l)break;o[i+c]=l}return c!==a&&(0!==c&&(e=e.slice(c)),i=t(i,a,a=c+3*e.length,1)>>>0,n=E().subarray(i+c,i+a),s=ze(e,n),c+=s.written,i=t(i,a,c,1)>>>0),_=c,i}let p=null;function Y(){return p=null===p||!0===p.buffer.detached||void 0===p.buffer.detached&&p.buffer!==s.memory.buffer?new DataView(s.memory.buffer):p}function D(e,r){return e>>>=0,E().subarray(+e,+e+r)}function d(e,r){r=r(+e.length,1)>>>0;return E().set(e,r),_=e.length,r}function Z(e,r){var t=d(e,s.__wbindgen_malloc),a=_;s.decryptQMC1(t,a,e,r)}function l(e){var r=s.__wbindgen_export_3.get(e);return s.__externref_table_dealloc(e),r}function He(e){var r=d(e,s.__wbindgen_malloc),t=_,r=s.decryptX2MHeader(r,t,e);if(r[1])throw l(r[0])}function Me(e){var r=d(e,s.__wbindgen_malloc),t=_,r=s.decryptX3MHeader(r,t,e);if(r[1])throw l(r[0])}function ge(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.detectAudioType(e,r);if(e[2])throw l(e[1]);return C.__wrap(e[0])}function fe(e,r){if(!(e instanceof r))throw new Error("expected instance of "+r.name)}function pe(e){return null==e}function Ae(){s.initPanicHook()}let ee="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_audiotyperesult_free(e>>>0,1));class C{static __wrap(e){e>>>=0;var r=Object.create(C.prototype);return r.__wbg_ptr=e,ee.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,ee.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_audiotyperesult_free(e,0)}get needMore(){return s.__wbg_get_audiotyperesult_needMore(this.__wbg_ptr)>>>0}set needMore(e){s.__wbg_set_audiotyperesult_needMore(this.__wbg_ptr,e)}get audioType(){let e,r;try{var t=s.__wbg_get_audiotyperesult_audioType(this.__wbg_ptr);return e=t[0],r=t[1],h(t[0],t[1])}finally{s.__wbindgen_free(e,r,1)}}set audioType(e){var e=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_;s.__wbg_set_audiotyperesult_audioType(this.__wbg_ptr,e,r)}}"u"<typeof FinalizationRegistry||new FinalizationRegistry(e=>s.__wbg_jooxfile_free(e>>>0,1));let te="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_kwmdecipher_free(e>>>0,1));class Re{__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,te.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_kwmdecipher_free(e,0)}constructor(e,r){fe(e,F);var r=pe(r)?0:g(r,s.__wbindgen_malloc,s.__wbindgen_realloc),t=_,e=s.kwmdecipher_make_decipher(e.__wbg_ptr,r,t);if(e[2])throw l(e[1]);return this.__wbg_ptr=e[0]>>>0,te.register(this,this.__wbg_ptr,this),this}decrypt(e,r){var t=d(e,s.__wbindgen_malloc),a=_;s.kwmdecipher_decrypt(this.__wbg_ptr,t,a,e,r)}}"u"<typeof FinalizationRegistry||new FinalizationRegistry(e=>s.__wbg_kwmdecipherv1_free(e>>>0,1));let re="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_kugou_free(e>>>0,1));class N{static __wrap(e){e>>>=0;var r=Object.create(N.prototype);return r.__wbg_ptr=e,re.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,re.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_kugou_free(e,0)}static from_header(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.kugou_from_header(e,r);if(e[2])throw l(e[1]);return N.__wrap(e[0])}static fromHeaderV5(e,r){fe(e,q);var r=pe(r)?0:g(r,s.__wbindgen_malloc,s.__wbindgen_realloc),t=_,e=s.kugou_fromHeaderV5(e.__wbg_ptr,r,t);if(e[2])throw l(e[1]);return N.__wrap(e[0])}decrypt(e,r){var t=d(e,s.__wbindgen_malloc),a=_;s.kugou_decrypt(this.__wbg_ptr,t,a,e,r)}static decryptDatabase(e){var r=d(e,s.__wbindgen_malloc),t=_,r=s.kugou_decryptDatabase(r,t,e);if(r[1])throw l(r[0])}}let ne="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_kugouheader_free(e>>>0,1));class q{__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,ne.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_kugouheader_free(e,0)}constructor(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.kugouheader_new(e,r);if(e[2])throw l(e[1]);return this.__wbg_ptr=e[0]>>>0,ne.register(this,this.__wbg_ptr,this),this}get audioHash(){let e,r;try{var t=s.kugouheader_audioHash(this.__wbg_ptr);return e=t[0],r=t[1],h(t[0],t[1])}finally{s.__wbindgen_free(e,r,1)}}get version(){return s.kugouheader_version(this.__wbg_ptr)>>>0}get offsetToData(){return s.kugouheader_offsetToData(this.__wbg_ptr)>>>0}}let ie="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_kuwoheader_free(e>>>0,1));class F{static __wrap(e){e>>>=0;var r=Object.create(F.prototype);return r.__wbg_ptr=e,ie.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,ie.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_kuwoheader_free(e,0)}static parse(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.kuwoheader_parse(e,r);if(e[2])throw l(e[1]);return F.__wrap(e[0])}get qualityId(){return s.kuwoheader_qualityId(this.__wbg_ptr)>>>0}get resourceId(){return s.kuwoheader_resourceId(this.__wbg_ptr)>>>0}}let se="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_migu3d_free(e>>>0,1));class z{static __wrap(e){e>>>=0;var r=Object.create(z.prototype);return r.__wbg_ptr=e,se.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,se.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_migu3d_free(e,0)}static fromHeader(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.migu3d_fromHeader(e,r);if(e[2])throw l(e[1]);return z.__wrap(e[0])}static fromFileKey(e){var e=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_,e=s.migu3d_fromFileKey(e,r);if(e[2])throw l(e[1]);return z.__wrap(e[0])}decrypt(e,r){var t=d(e,s.__wbindgen_malloc),a=_;s.migu3d_decrypt(this.__wbg_ptr,t,a,e,r)}}let oe="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_ncmfile_free(e>>>0,1));class Ue{__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,oe.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_ncmfile_free(e,0)}constructor(){var e=s.ncmfile_new();if(e[2])throw l(e[1]);return this.__wbg_ptr=e[0]>>>0,oe.register(this,this.__wbg_ptr,this),this}open(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.ncmfile_open(this.__wbg_ptr,e,r);if(e[2])throw l(e[1]);return e[0]}decrypt(e,r){var t=d(e,s.__wbindgen_malloc),a=_,t=s.ncmfile_decrypt(this.__wbg_ptr,t,a,e,r);if(t[1])throw l(t[0])}get audioOffset(){var e=s.ncmfile_audioOffset(this.__wbg_ptr);if(e[2])throw l(e[1]);return e[0]>>>0}}let T="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_qmc2_free(e>>>0,1));class B{static __wrap(e){e>>>=0;var r=Object.create(B.prototype);return r.__wbg_ptr=e,T.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,T.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_qmc2_free(e,0)}constructor(e){var e=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_,e=s.qmc2_new(e,r);if(e[2])throw l(e[1]);return this.__wbg_ptr=e[0]>>>0,T.register(this,this.__wbg_ptr,this),this}decrypt(e,r){var t=d(e,s.__wbindgen_malloc),a=_;s.qmc2_decrypt(this.__wbg_ptr,t,a,e,r)}}let ae="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_qmcfooter_free(e>>>0,1));class H{static __wrap(e){e>>>=0;var r=Object.create(H.prototype);return r.__wbg_ptr=e,ae.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,ae.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_qmcfooter_free(e,0)}static parse(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.qmcfooter_parse(e,r);if(e[2])throw l(e[1]);return 0===e[0]?void 0:H.__wrap(e[0])}get ekey(){var e=s.qmcfooter_ekey(this.__wbg_ptr);let r;return 0!==e[0]&&(r=h(e[0],e[1]).slice(),s.__wbindgen_free(e[0],+e[1],1)),r}get size(){return s.qmcfooter_size(this.__wbg_ptr)>>>0}get mediaName(){var e=s.qmcfooter_mediaName(this.__wbg_ptr);let r;return 0!==e[0]&&(r=h(e[0],e[1]).slice(),s.__wbindgen_free(e[0],+e[1],1)),r}}let _e="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_qingtingfm_free(e>>>0,1));class S{__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,_e.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_qingtingfm_free(e,0)}static getDeviceKey(e,r,t,a,i,n){var e=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),o=_,r=g(r,s.__wbindgen_malloc,s.__wbindgen_realloc),c=_,t=g(t,s.__wbindgen_malloc,s.__wbindgen_realloc),l=_,a=g(a,s.__wbindgen_malloc,s.__wbindgen_realloc),d=_,i=g(i,s.__wbindgen_malloc,s.__wbindgen_realloc),w=_,n=g(n,s.__wbindgen_malloc,s.__wbindgen_realloc),u=_,e=s.qingtingfm_getDeviceKey(e,o,r,c,t,l,a,d,i,w,n,u),o=D(e[0],e[1]).slice();return s.__wbindgen_free(e[0],+e[1],1),o}static getFileIV(e){var e=g(e,s.__wbindgen_malloc,s.__wbindgen_realloc),r=_,e=s.qingtingfm_getFileIV(e,r);if(e[3])throw l(e[2]);r=D(e[0],e[1]).slice();return s.__wbindgen_free(e[0],+e[1],1),r}constructor(e,r){var e=d(e,s.__wbindgen_malloc),t=_,r=d(r,s.__wbindgen_malloc),a=_,e=s.qingtingfm_new(e,t,r,a);if(e[2])throw l(e[1]);return this.__wbg_ptr=e[0]>>>0,_e.register(this,this.__wbg_ptr,this),this}decrypt(e,r){var t=d(e,s.__wbindgen_malloc),a=_;s.qingtingfm_decrypt(this.__wbg_ptr,t,a,e,r)}}let ce="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_xiami_free(e>>>0,1));class I{static __wrap(e){e>>>=0;var r=Object.create(I.prototype);return r.__wbg_ptr=e,ce.register(r,r.__wbg_ptr,r),r}__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,ce.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_xiami_free(e,0)}static from_header(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.xiami_from_header(e,r);if(e[2])throw l(e[1]);return I.__wrap(e[0])}decrypt(e){var r=d(e,s.__wbindgen_malloc),t=_;s.xiami_decrypt(this.__wbg_ptr,r,t,e)}get copyPlainLength(){return s.xiami_copyPlainLength(this.__wbg_ptr)>>>0}}let de="u"<typeof FinalizationRegistry?{register:()=>{},unregister:()=>{}}:new FinalizationRegistry(e=>s.__wbg_xmlypc_free(e>>>0,1));class le{__destroy_into_raw(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,de.unregister(this),e}free(){var e=this.__destroy_into_raw();s.__wbg_xmlypc_free(e,0)}static getHeaderSize(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.xmlypc_getHeaderSize(e,r);if(e[2])throw l(e[1]);return e[0]>>>0}constructor(e){var e=d(e,s.__wbindgen_malloc),r=_,e=s.xmlypc_new(e,r);if(e[2])throw l(e[1]);return this.__wbg_ptr=e[0]>>>0,de.register(this,this.__wbg_ptr,this),this}get audioHeader(){var e=s.xmlypc_audioHeader(this.__wbg_ptr),r=D(e[0],e[1]).slice();return s.__wbindgen_free(e[0],+e[1],1),r}get encryptedHeaderOffset(){return s.xmlypc_encryptedHeaderOffset(this.__wbg_ptr)>>>0}get encryptedHeaderSize(){return s.xmlypc_encryptedHeaderSize(this.__wbg_ptr)>>>0}decrypt(e){var r=d(e,s.__wbindgen_malloc),t=_,r=s.xmlypc_decrypt(this.__wbg_ptr,r,t,e);if(r[2])throw l(r[1]);return r[0]>>>0}}async function xe(r,e){if("function"==typeof Response&&r instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(r,e)}catch(e){if("application/wasm"==r.headers.get("Content-Type"))throw e;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve Wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e)}var t=await r.arrayBuffer();return WebAssembly.instantiate(t,e)}return(t=await WebAssembly.instantiate(r,e))instanceof WebAssembly.Instance?{instance:t,module:r}:t}function Ke(){var e={wbg:{}};return e.wbg.__wbg_error_7534b8e9a36f1ab4=function(e,r){let t,a;try{t=e,a=r,console.error(h(e,r))}finally{s.__wbindgen_free(t,a,1)}},e.wbg.__wbg_new_8a6f238a6ece86ea=function(){return new Error},e.wbg.__wbg_stack_0ed75d68575b0f3c=function(e,r){var r=g(r.stack,s.__wbindgen_malloc,s.__wbindgen_realloc),t=_;Y().setInt32(e+4,t,!0),Y().setInt32(e+0,r,!0)},e.wbg.__wbindgen_copy_to_typed_array=function(e,r,t){new Uint8Array(t.buffer,t.byteOffset,t.byteLength).set(D(e,r))},e.wbg.__wbindgen_error_new=function(e,r){return new Error(h(e,r))},e.wbg.__wbindgen_init_externref_table=function(){var e=s.__wbindgen_export_3,r=e.grow(4);e.set(0,void 0),e.set(r+0,void 0),e.set(r+1,null),e.set(r+2,!0),e.set(r+3,!1)},e.wbg.__wbindgen_throw=function(e,r){throw new Error(h(e,r))},e}function De(e,r){return s=e.exports,ye.__wbindgen_wasm_module=r,p=null,v=null,s.__wbindgen_start(),s}async function ye(e){if(void 0!==s)return s;typeof e<"u"&&(Object.getPrototypeOf(e)===Object.prototype?e=e.module_or_path:console.warn("using deprecated parameters for the initialization function; pass a single object instead")),"u"<typeof e&&(e=new URL("/assets/um_wasm_bg-BhXEaAwz.wasm",import.meta.url));var r=Ke(),{instance:e,module:r}=await xe(await(e="string"==typeof e||"function"==typeof Request&&e instanceof Request||"function"==typeof URL&&e instanceof URL?fetch(e):e),r);return De(e,r)}function Ie(){{let r=new URL("/assets/um_wasm_bg-BhXEaAwz.wasm",import.meta.url),e="file:"===r.protocol?import("node:fs/promises").then(e=>e.readFile(r)).catch(e=>{console.log("read wasm failed",e)}):void 0;return ye({module_or_path:e}).then(()=>(Ae(),!0))}}function Le(){return"0.1.10"}let Oe=Ie();async function Te(e,r){return r()}async function Se(e,r){return r()}let Ce=e=>e instanceof Blob?e:new Blob([e]);function*f(r,t=4096){var a=r.byteLength;for(let e=0;e<a;e+=t){var _=Math.min(e+t,a);yield[r.subarray(e,_),e]}}class P{cipherName="NCM/PC";tryInit(e,r){let t=1024;for(;0!==t;)if(console.debug("NCM/open: read %d bytes",t),-1===(t=e.open(r.subarray(0,t))))throw new y("file is not ncm")}async decrypt(e){var r=new Ue;try{this.tryInit(r,e);var t,a,_=e.slice(r.audioOffset);for([t,a]of f(_))r.decrypt(t,a);return{status:w.OK,cipherName:this.cipherName,data:_}}finally{r.free()}}static make(){return new P}}class j{cipherName="none";async decrypt(e){return{cipherName:"None",status:w.OK,data:e,message:"No decipher applied"}}static make(){return new j}}function qe(e){let r=256,t="bin";for(;0!==r;){console.debug("AudioDetect: read %d bytes",r);var a=ge(e.subarray(0,r));t=a.audioType,r=a.needMore,a.free()}return t}function he(e){var r;return!(e.byteLength<32)&&(r=0!==(e=ge(e.subarray(0,32))).needMore||"bin"!==e.audioType,e.free(),r)}class W{cipherName="QQMusic/QMC1";async decrypt(e){var r=e.slice(0,32);if(Z(r,0),!he(r))throw new y("does not look like QMC file");var t,a,r=new Uint8Array(e);for([t,a]of f(r))Z(t,a);return{status:w.OK,cipherName:this.cipherName,data:r}}static create(){return new W}}class M{constructor(e){this.useUserKey=e,this.cipherName=`QQMusic/QMC2(user_key=${+e})`}cipherName;parseFooter(e){var r,t,e=H.parse(e.subarray(e.byteLength-1024));if(e)return{size:r,ekey:t}=e,e.free(),{size:r,ekey:t};if(this.useUserKey)return{size:0};throw new y("Not QMC2 File")}async decrypt(e,r){var t=this.parseFooter(e.subarray(e.byteLength-1024)),r=this.useUserKey?r.qmc2Key:t.ekey;if(!r)throw new Error("EKey required");var a,_,i=new B(r),r=e.slice(0,e.byteLength-t.size);for([a,_]of f(r))i.decrypt(a,_);return i.free(),{status:w.OK,cipherName:this.cipherName,data:r}}static createWithUserKey(){return new M(!0)}static createWithEmbeddedEKey(){return new M(!1)}}class X{cipherName="Kuwo";async decrypt(e,r){let t,a;try{t=F.parse(e.subarray(0,1024)),a=new Re(t,r.kwm2key);var _,i,n=new Uint8Array(e.subarray(1024));for([_,i]of f(n))a.decrypt(_,i);return{status:w.OK,cipherName:this.cipherName,data:n}}finally{a?.free(),t?.free()}}static make(){return new X}}class Q{cipherName="Kugou";async decrypt(e,r){let t,a;try{a=new q(e.subarray(0,1024)),t=N.fromHeaderV5(a,r.kugouKey);var _,i,n=new Uint8Array(e.subarray(1024));for([_,i]of f(n))t.decrypt(_,i);return{status:w.OK,cipherName:this.cipherName,data:n}}finally{a?.free(),t?.free()}}static make(){return new Q}}class A{constructor(e,r){this.decipher=e,this.cipherType=r,this.cipherName=`Ximalaya (Android, ${r})`}cipherName;async decrypt(e,r){var t=e.slice(0,1024);if(this.decipher(t),he(t))return(e=new Uint8Array(e)).set(t,0),{cipherName:this.cipherName,status:w.OK,data:e};throw new y(`Not a Xmly android file (${this.cipherType})`)}static makeX2M(){return new A(He,"X2M")}static makeX3M(){return new A(Me,"X3M")}}class V{cipherName="Ximalaya (PC)";async decrypt(e,r){var t=le.getHeaderSize(e.subarray(0,1024)),t=new le(e.subarray(0,t)),{audioHeader:a,encryptedHeaderOffset:_,encryptedHeaderSize:i}=t,i=_+i,n=e.byteLength-i,_=e.slice(_,i),s=t.decrypt(_),n=a.byteLength+s+n,t=(t.free(),new Uint8Array(n));return t.set(a),t.set(_,a.byteLength),t.set(e.subarray(i),a.byteLength+s),{status:w.OK,data:t,cipherName:this.cipherName}}static make(){return new V}}class G{cipherName="Xiami (XM)";async decrypt(e){var r,t=I.from_header(e.subarray(0,16)),a=t.copyPlainLength,e=e.slice(16);for([r]of f(e.subarray(a)))t.decrypt(r);return t.free(),{cipherName:this.cipherName,status:w.OK,data:e}}static make(){return new G}}function Be(e){return Array.from(e,e=>e.toString(16).padStart(2,"0")).join("")}function Pe(e){var r,t=[];for([r]of e.matchAll(/[0-9a-fA-F]{2}/g))t.push(parseInt(r,16));return new Uint8Array(t)}class ${cipherName="QingTingFM (Android, qta)";async decrypt(e,r){var t=Pe(r.qingTingAndroidKey||""),r=S.getFileIV(r.fileName);if(16!==t.byteLength||16!==r.byteLength)return{status:w.FAILED,message:"device key or iv invalid"};var a,_,i=new S(t,r),t=new Uint8Array(e);for([a,_]of f(t))i.decrypt(a,_);return{cipherName:this.cipherName,status:w.OK,data:t}}static make(){return new $}}class J{cipherName="Migu3D (Keyless)";async decrypt(e){var r,t,a=z.fromHeader(e.subarray(0,256)),e=new Uint8Array(e);for([r,t]of f(e))a.decrypt(r,t);return a.free(),{cipherName:this.cipherName,status:w.OK,data:e}}static make(){return new J}}var w=(e=>(e[e.OK=0]="OK",e[e.NOT_THIS_CIPHER=1]="NOT_THIS_CIPHER",e[e.FAILED=2]="FAILED",e))(w||{});let je=[P.make,Q.make,X.make,V.make,G.make,$.make,M.createWithUserKey,M.createWithEmbeddedEKey,J.make,W.create,A.makeX2M,A.makeX3M,j.make];async function We(e){try{return[await e,null]}catch(e){return[null,e]}}class Xe{constructor(e,r,t){this.buffer=r,this.options=t,this.label=`DecryptCommandHandler(${e})`}label;log(e,r){return Te(this.label+": "+e,r)}async decrypt(e){var r,t=[];for(r of e){var a=r(),[_,i]=await We(this.tryDecryptWith(a));if(i){var n=i.message;n&&t.push(a.cipherName+": "+n),i instanceof y?console.debug("[%s] Not this decipher:",a.cipherName,i):console.error("decrypt failed with unknown error: ",i)}else{if(_)return _;t.push(a.cipherName+": no response")}}throw new y(t.join(`
`))}async tryDecryptWith(e){var r=await this.log("try decrypt with "+e.cipherName,async()=>e.decrypt(this.buffer,this.options));switch(r.status){case w.NOT_THIS_CIPHER:return null;case w.FAILED:throw new Error("failed: "+r.message)}let t=r.overrideExtension||qe(r.data);if(r.overrideExtension||"bin"!==t)return"mp4"===t.toLowerCase()&&(t="m4a"),{decrypted:URL.createObjectURL(Ce(r.data)),ext:t};throw new y("unable to produce valid audio file")}}let Qe=async({id:e,blobURI:r,options:t})=>{await Oe;let a=e.replace("://",":"),_=`decrypt(${a})`;return Se(_,async()=>{var e=await fetch(r).then(e=>e.arrayBuffer());return new Xe(a,new Uint8Array(e),t).decrypt(je)})},Ve=async({blobURI:e})=>{e=await(await fetch(e,{headers:{Range:"bytes=-1024"}}).then(e=>e.blob())).arrayBuffer();try{var r=new Uint8Array(e.slice(-1024));return H.parse(r)?.mediaName||null}catch{return null}};async function Ge({device:e,brand:r,model:t,product:a,manufacturer:_,board:i}){return Be(S.getDeviceKey(e,r,t,a,_,i))}let $e=async({blobURI:e})=>{e=await(await fetch(e,{headers:{Range:"bytes=0-1023"}}).then(e=>e.blob())).arrayBuffer();try{var r=new Uint8Array(e.slice(0,1024)),t=F.parse(r),{qualityId:a,resourceId:_}=t;return t.free(),{qualityId:a,resourceId:_}}catch{return null}},Je=async({blobURI:e})=>{e=await(await fetch(e,{headers:{Range:"bytes=0-1023"}}).then(e=>e.blob())).arrayBuffer(),e=new Uint8Array(e.slice(0,1024));let r;try{var{version:t,audioHash:a}=r=new q(e);return{version:t,audioHash:a}}catch{return null}finally{r?.free()}},m=new Ne;onmessage=m.onmessage,m.addEventHandler(b.DECRYPT,Qe),m.addEventHandler(b.FIND_QMC_MUSICEX_NAME,Ve),m.addEventHandler(b.VERSION,Le),m.addEventHandler(b.KUWO_PARSE_HEADER,$e),m.addEventHandler(b.KUGOU_PARSE_HEADER,Je),m.addEventHandler(b.QINGTING_FM_GET_DEVICE_KEY,Ge);